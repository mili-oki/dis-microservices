package com.example.dis.auth;

import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.boot.test.web.client.TestRestTemplate;
import org.springframework.boot.test.web.server.LocalServerPort;
import org.springframework.http.*;

import java.util.Map;

import static org.assertj.core.api.Assertions.assertThat;

@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT,
        properties = { "spring.profiles.active=test" })
class AuthApiIT {

    @LocalServerPort
    int port;

    @Autowired
    TestRestTemplate rest;

    @Test
    void register_and_login_flow() {
        String base = "http://localhost:" + port;

        // register
        var regRes = rest.postForEntity(base + "/auth/register",
                Map.of("email","test@ex.com","password","pwd"), String.class);
        assertThat(regRes.getStatusCode().is2xxSuccessful()).isTrue();

        // login
        var loginRes = rest.postForEntity(base + "/auth/login",
                Map.of("email","test@ex.com","password","pwd"), String.class);
        assertThat(loginRes.getStatusCode()).isEqualTo(HttpStatus.OK);
        assertThat(loginRes.getBody()).contains("token");
    }
}
