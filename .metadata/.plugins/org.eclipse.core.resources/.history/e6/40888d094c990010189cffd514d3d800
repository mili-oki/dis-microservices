package com.example.dis.notifications_service;

import com.example.dis.notifications_service.web.PaymentNotification;
import org.junit.jupiter.api.Test;
import org.springframework.amqp.rabbit.core.RabbitTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.boot.test.mock.mockito.MockBean;
import org.springframework.boot.test.web.client.TestRestTemplate;
import org.springframework.boot.test.web.server.LocalServerPort;
import org.springframework.http.*;

import java.math.BigDecimal;

import static org.assertj.core.api.Assertions.assertThat;

@SpringBootTest(
        webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT,
        properties = { "spring.profiles.active=test" }
)
class NotificationsApiIT {

    @LocalServerPort
    int port;

    @Autowired
    TestRestTemplate rest;


    @MockBean
    RabbitTemplate rabbitTemplate;

    @Test
    void postPaymentNotification_returns_202() {
        String base = "http://localhost:" + port;

        PaymentNotification payload = new PaymentNotification();
        payload.setOrderId(10L);
        payload.setAmount(new BigDecimal("99.99"));
        payload.setStatus("SUCCESS");
        payload.setMessage("ok");

        ResponseEntity<Void> res = rest.postForEntity(
                base + "/notifications/payment",
                payload,
                Void.class
        );

        assertThat(res.getStatusCode()).isEqualTo(HttpStatus.ACCEPTED);
    }
}
